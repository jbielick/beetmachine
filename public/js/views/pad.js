// Generated by CoffeeScript 1.6.3
(function() {
  var __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  define(['jquery', 'underscore', 'backbone', 'models/sound', 'views/editor', 'ligaments', 'text!/js/templates/pad.ejs'], function($, _, Backbone, SoundModel, SoundEditor, ligaments, PadTemplate) {
    var PadView, _ref;
    return PadView = (function(_super) {
      __extends(PadView, _super);

      function PadView() {
        _ref = PadView.__super__.constructor.apply(this, arguments);
        return _ref;
      }

      PadView.prototype.attributes = {
        "class": 'small-3 columns pad-container'
      };

      PadView.prototype.template = _.template(PadTemplate);

      PadView.prototype.initialize = function(options) {
        this.parent = options.parent;
        this.name = options.name;
        _.bindAll(this, 'listenToModelChanges', 'press');
        this.on('modelPresent', this.listenToModelChanges);
        return this.render();
      };

      PadView.prototype.listenToModelChanges = function() {
        var _this = this;
        this.stopListening(this.model, 'press');
        this.listenTo(this.model, 'press', this.press);
        this.stopListening(this.model, 'change:fx.*');
        return this.listenTo(this.model, 'change:fx.*', function(model, attrs) {
          _this.timbreContextAttached = false;
          return _this.rendered = false;
        });
      };

      PadView.prototype.bootstrapWithModel = function(sound) {
        var _this = this;
        if (!sound && !sound instanceof SoundModel) {
          throw new Error('Must provide a SoundModel instance when mapping a pad.');
        }
        (this.model = sound).pad = this;
        if (this.model.get('keyCode')) {
          this.model.set('key', String.fromCharCode(this.model.get('keyCode')));
        }
        new Backbone.Ligaments({
          model: this.model,
          view: this
        });
        return this.loadSrc(this.model.get('src'), function() {
          return _this.trigger('modelPresent');
        });
      };

      PadView.prototype.render = function() {
        return this.el.innerHTML = this.template({
          name: this.name
        });
      };

      PadView.prototype.events = {
        'contextmenu .pad': 'edit',
        'mousedown .pad': 'press',
        'mouseup .pad': 'release',
        'dragover': 'prevent',
        'dragenter': 'prevent',
        'drop': 'uploadSample'
      };

      PadView.prototype.prevent = function(e) {
        e.preventDefault();
        return e.stopPropagation();
      };

      PadView.prototype.press = function(e) {
        var _this = this;
        if (e && e.button === 2) {
          return true;
        }
        this.$('.pad').addClass('active');
        setTimeout(function() {
          return _this.$('.pad').removeClass('active');
        }, 50);
        if (this.loaded) {
          return this.play().parent.record(this);
        }
      };

      PadView.prototype.release = function(e) {};

      PadView.prototype.play = function() {
        var sound, _ref1, _this;
        _this = _this;
        if (!this.rendered) {
          sound = this.renderEffects();
          if (!this.timbreContextAttached) {
            this.timbreContextAttached = true;
            sound.play();
          } else {
            sound.bang();
          }
        } else {
          if ((_ref1 = this.T.rendered) != null ? _ref1.playbackState : void 0) {
            this.T.rendered.currentTime = 0;
          } else {
            this.T.rendered.bang();
          }
        }
        return this;
      };

      /*
      		 # creates a new model when a pad has a file dropped
      		 # onto it. Add itself to the current group's SoundCollection
      */


      PadView.prototype.createModel = function(attrs) {
        if (attrs == null) {
          attrs = {};
        }
        this.model = new SoundModel(_.extend({
          pad: this.$el.index() + 1
        }, attrs));
        this.parent.currentGroup.sounds.add(this.model);
        return this.model;
      };

      PadView.prototype.loadSrc = function(url, cb) {
        var _this;
        _this = this;
        if (url || this.model.get('src')) {
          return T('audio').load(url || this.model.get('src'), function() {
            _this.T = {
              raw: this
            };
            _this.loaded = true;
            _this.$('.pad').addClass('mapped');
            _this.parent.app.display.log(_this.name + ' loaded');
            if (cb) {
              return cb.call(_this, this);
            }
          });
        }
      };

      PadView.prototype.renderEffects = function(cb) {
        var sound,
          _this = this;
        sound = null;
        if (this.T) {
          delete this.T.rendered;
        }
        this.T.rendered = this.T.raw.clone();
        _.each(this.model.get('fx'), function(params, fx) {
          return sound = T(fx, params, sound || _this.T.rendered);
        });
        this.rendered = true;
        return sound || this.T.rendered;
      };

      PadView.prototype.uploadSample = function(e) {
        var objectUrl,
          _this = this;
        e = e.originalEvent;
        e.preventDefault();
        e.stopPropagation();
        if (!this.model) {
          this.createModel();
        }
        objectUrl = URL.createObjectURL(e.dataTransfer.files[0]);
        this.model.set('src', objectUrl, {
          silent: true
        });
        this.loadSrc(objectUrl, function() {
          return _this.trigger('modelPresent');
        });
        return this.parent.app.display.log('New Sample Uploaded on ' + this.name + ': ' + e.dataTransfer.files[0].name);
      };

      PadView.prototype.edit = function(e) {
        var editor;
        e.preventDefault();
        if (!this.editor) {
          editor = new SoundEditor({
            model: this.model || this.createModel(),
            pad: this
          });
          return this.editor = editor;
        } else {
          return this.editor.show();
        }
      };

      return PadView;

    })(Backbone.View);
  });

}).call(this);
