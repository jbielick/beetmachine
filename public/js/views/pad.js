// Generated by CoffeeScript 1.6.3
(function() {
  var __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  define(['jquery', 'underscore', 'backbone', 'models/sound', 'views/editor', 'ligaments', 'text!/js/templates/pad.ejs'], function($, _, Backbone, SoundModel, SoundEditor, ligaments, PadTemplate) {
    var PadView, _ref;
    return PadView = (function(_super) {
      __extends(PadView, _super);

      function PadView() {
        _ref = PadView.__super__.constructor.apply(this, arguments);
        return _ref;
      }

      PadView.prototype.attributes = {
        "class": 'small-3 columns pad-container'
      };

      PadView.prototype.template = _.template(PadTemplate);

      PadView.prototype.initialize = function(options) {
        this.parent = options.parent;
        this.name = options.name;
        return this.render();
      };

      PadView.prototype.map = function(sound) {
        if (!sound) {
          throw new Error('Must provide a SoundModel instance when mapping a pad.');
        }
        this.model = sound;
        sound.pad = this;
        if (this.model.get('keyCode')) {
          this.model.set('key', String.fromCharCode(this.model.get('keyCode')));
        }
        new Backbone.Ligaments({
          model: this.model,
          view: this
        });
        this.listenTo(this.model, 'change', function() {
          this.contextAttached = false;
          return this.renderEffects();
        });
        return this.initPlayer();
      };

      PadView.prototype.render = function() {
        return this.el.innerHTML = this.template({
          name: this.name
        });
      };

      PadView.prototype.events = {
        'contextmenu .pad': 'edit',
        'mousedown .pad': 'press',
        'mouseup .pad': 'release',
        'dragover': 'prevent',
        'dragenter': 'prevent',
        'drop': 'loadSample'
      };

      PadView.prototype.prevent = function(e) {
        e.preventDefault();
        return e.stopPropagation();
      };

      PadView.prototype.press = function(e) {
        var _this = this;
        if (e && e.button === 2) {
          return true;
        }
        this.$('.pad').addClass('active');
        setTimeout(function() {
          return _this.$('.pad').removeClass('active');
        }, 50);
        if (this.loaded) {
          this.parent.record(this);
          return this.play();
        }
      };

      PadView.prototype.release = function(e) {};

      PadView.prototype.play = function() {
        var _ref1, _this;
        _this = this;
        if (!this.contextAttached) {
          this.contextAttached = true;
          return this.renderEffects(function(sound) {
            return sound.play();
          });
        } else {
          if ((_ref1 = this.T.rendered) != null ? _ref1.playbackState : void 0) {
            return this.T.rendered.currentTime = 0;
          } else if (this.T.rendered != null) {
            return this.T.rendered.bang();
          } else {

          }
        }
      };

      /*
      		 # creates a new model when a pad has a file dropped
      		 # onto it. Add itself to the current group's SoundCollection
      */


      PadView.prototype.createModel = function(attrs) {
        if (attrs == null) {
          attrs = {};
        }
        this.model = new SoundModel(_.extend({
          pad: this.$el.index() + 1
        }, attrs));
        return this.parent.currentGroup.sounds.add(this.model);
      };

      PadView.prototype.initPlayer = function(objectURL) {
        var _this;
        _this = this;
        this.players = [];
        if (objectURL || this.model.get('src')) {
          T('audio').load(objectURL || this.model.get('src'), function() {
            _this.T = {
              raw: this
            };
            return _this.loaded = true;
          });
          this.$('.pad').addClass('mapped');
          return this.parent.app.display.log(this.name + ' loaded');
        }
      };

      PadView.prototype.renderEffects = function(cb) {
        var _this = this;
        clearTimeout(this.timeout);
        return this.timeout = setTimeout(function() {
          var original, sound;
          sound = null;
          if (_this.T) {
            delete _this.T.rendered;
          }
          original = _this.T.raw.clone();
          _.each(_this.model.get('fx'), function(params, fx) {
            return sound = T(fx, params, sound || original);
          });
          _this.T.rendered = original;
          if (cb) {
            return cb(sound || original);
          }
        }, 200);
      };

      PadView.prototype.loadSample = function(e) {
        e = e.originalEvent;
        e.preventDefault();
        e.stopPropagation();
        if (!this.model) {
          this.createModel();
        }
        this.model.set('src', URL.createObjectURL(e.dataTransfer.files[0]));
        this.initPlayer(URL.createObjectURL(e.dataTransfer.files[0]));
        return this.parent.app.display.log('New Sample Uploaded on ' + this.name + ': ' + e.dataTransfer.files[0].name);
      };

      PadView.prototype.edit = function(e) {
        var editor;
        e.preventDefault();
        if (!this.editor) {
          editor = new SoundEditor({
            model: this.model,
            pad: this
          });
          return this.editor = editor;
        } else {
          return this.editor.show();
        }
      };

      return PadView;

    })(Backbone.View);
  });

}).call(this);
